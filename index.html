<!doctype HTML>
<html>
    <head>
        <title>Youtube Music</title>
        <meta charset="utf-8">
        <link rel="manifest" href="manifest.json">
        <link rel="shortcut icon" href="images/youzic.ico">
        <link rel="apple-touch-icon" href="images/youzic-512.png">
        <link rel="stylesheet" href="css/base.css" type="text/css">
        <link rel="stylesheet" href="css/editor.css" type="text/css">
        <link rel="stylesheet" href="css/swiper-bundle.min.css" type="text/css">
        <script src="js/jquery-3.7.1.min.js"></script>
        <script src="js/sweetalert2.all.min.js"></script>
        <script src="js/sw-main.js"></script>
        <script src="https://www.youtube.com/iframe_api"></script>
        <script src="js/players.js"></script>
        <script src="js/swiper-bundle.min.js"></script>
        <script src="js/indexedDB.js"></script>
        <script src="js/editor.js"></script>
        <script src="js/user.js"></script>
        <script src="js/wakeLock.js"></script>
    </head>
    <body>
        <div class="video-container" id="videoPlayer">
            <!-- Le lecteur vid√©o ou audio sera charg√© ici -->
        </div>
        
        <!-- partie slidable -->
        <div class="swiper">
            <!-- Additional required wrapper -->
            <div class="swiper-wrapper">
                <!-- Slides -->
                <div class="swiper-slide">
                    <!-- Page 1 -->
                    <div class="liste1">
                        <!-- Boutons pour lire les vid√©os seront plac√©s ici-->
                        <!-- Animation de chargement-->
                        <span id="loader" class="loader">
                            <span class="loader-inner"></span>
                        </span>
                    </div>
                    <!-- fin page 1 -->
                </div>
                <div class="swiper-slide">
                    <!-- Page 2 -->
                    <div class="liste2">
                        <!-- Boutons pour lire les web radios seront plac√©s ici-->
                    </div>
                    <!-- fin page 2-->
                </div>    
                <div class="swiper-slide">    
                    <!-- Page 3 -->
                    <div class="liste3">
                        <!-- Boutons pour lire les playlist youtube seront plac√©s ici-->
                    </div>
                    <!-- fin page 3-->
                </div>
            </div>
        </div>
        <!-- Overlay mode √©dition -->
        <div id="editModeOverlay" class="edit-mode-overlay"></div>
        <!-- Menu Unifi√© -->
        <button id="unifiedMenuBtn" class="unified-menu-btn">‚ò∞</button>
        
        <div id="unifiedMenu" class="unified-menu">
            <div class="unified-menu-content">
                <button id="editModeMenuBtn" class="menu-item">
                    <span class="menu-icon">‚úèÔ∏è</span>
                    <span class="menu-label">Mode √©dition</span>
                </button>
                <button id="addItemMenuBtn" class="menu-item">
                    <span class="menu-icon">‚ûï</span>
                    <span class="menu-label">Ajouter m√©dia</span>
                </button>
                <button id="exportMenuBtn" class="menu-item">
                    <span class="menu-icon">üíæ</span>
                    <span class="menu-label">Exporter</span>
                </button>
                <button id="importMenuBtn" class="menu-item">
                    <span class="menu-icon">üóÇÔ∏è</span>
                    <span class="menu-label">Importer</span>
                </button>
            </div>
        </div>
        
        <input type="file" id="importFile" accept=".json" style="display: none;">
        
        <script src="js/swiper-conf.js"></script>
        <script>
            // Fonction pour d√©tecter quelle liste est visible
            function getVisibleList() {
                console.log('=== GET VISIBLE LIST ===');
                const slides = document.querySelectorAll('.swiper-slide');
                console.log('Nombre de slides trouv√©es:', slides.length);
                
                for (let i = 0; i < slides.length; i++) {
                    const slide = slides[i];
                    const hasVisible = slide.classList.contains('swiper-slide-visible');
                    const slideIndex = slide.getAttribute('data-swiper-slide-index');
                    console.log(`Slide ${i}: data-swiper-slide-index=${slideIndex}, swiper-slide-visible=${hasVisible}`);
                    
                    // Utiliser swiper-slide-visible au lieu de swiper-slide-active
                    if (hasVisible) {
                        const index = parseInt(slideIndex);
                        console.log('‚úÖ Slide visible d√©tect√©e! Index:', index);
                        
                        const listMapping = [
                            { key: 'youtubeChannels', class: '.liste1', index: 0 },
                            { key: 'radioStations', class: '.liste2', index: 1 },
                            { key: 'youtubePlaylists', class: '.liste3', index: 2 }
                        ];
                        
                        const result = listMapping[index] || listMapping[0];
                        console.log('R√©sultat mapp√©:', result);
                        return result;
                    }
                }
                // Par d√©faut
                console.log('‚ö†Ô∏è Aucune slide visible trouv√©e, retour par d√©faut');
                return { key: 'youtubeChannels', class: '.liste1', index: 0 };
            }
            
            // Variable pour √©viter l'initialisation multiple
            let editModeInitialized = false;
            
            // Polling pour attendre que le swiper soit pr√™t
            function waitForSwiper(callback) {
                if (window.swiper && window.swiper.activeIndex !== undefined) {
                    callback();
                } else {
                    setTimeout(() => waitForSwiper(callback), 100);
                }
            }
            
            waitForSwiper(function() {
                if (editModeInitialized) {
                    console.log('‚ö†Ô∏è Edit mode d√©j√† initialis√©, sortie');
                    return;
                }
                editModeInitialized = true;
                console.log('Swiper d√©tect√© et pr√™t');
                
                // Gestion du menu unifi√©
                const unifiedMenuBtn = document.getElementById("unifiedMenuBtn");
                const unifiedMenu = document.getElementById("unifiedMenu");
                const editModeMenuBtn = document.getElementById("editModeMenuBtn");
                const addItemMenuBtn = document.getElementById("addItemMenuBtn");
                const exportMenuBtn = document.getElementById("exportMenuBtn");
                const importMenuBtn = document.getElementById("importMenuBtn");
                
                // Ouvrir/Fermer le menu OU sortir du mode √©dition
                unifiedMenuBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    
                    // Si on est en mode √©dition, cliquer ferme le mode √©dition
                    if (isEditMode) {
                        const current = getVisibleList();
                        toggleEditMode(current.key, current.class);
                    } else {
                        // Sinon, ouvrir le menu normalement
                        unifiedMenu.classList.toggle("active");
                    }
                });
                
                // Fermer le menu en cliquant √† l'ext√©rieur
                unifiedMenu.addEventListener("click", (e) => {
                    e.stopPropagation();
                    if (e.target === unifiedMenu) {
                        unifiedMenu.classList.remove("active");
                    }
                });
                
                // Mode √©dition
                editModeMenuBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    const current = getVisibleList();
                    toggleEditMode(current.key, current.class);
                    unifiedMenu.classList.remove("active");
                });
                
                // Ajouter m√©dia
                addItemMenuBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    addNewItem();
                    unifiedMenu.classList.remove("active");
                });
                
                // Exporter
                exportMenuBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    exportDB();
                    unifiedMenu.classList.remove("active");
                });
                
                // Importer
                importMenuBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    document.getElementById("importFile").click();
                    unifiedMenu.classList.remove("active");
                });
            });
        </script>
        
        <script>
            document.getElementById("importFile").addEventListener("change", function () {
                if (this.files.length > 0) {
                    importAndReplaceDB(this.files[0]);
                }
            });
        </script>        
    </body>
</html>
